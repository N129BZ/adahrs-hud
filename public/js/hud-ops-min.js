"use strict";var host,websock,trafficWebSocket,ahrsWebSocket,warningIdentity,warningAltitude,warningDistance,warningCourse,hitmap=new Map,wsOpen=!1,clrCount=0,countCycle=0,myAlt=0,warning_altitude=0,warning_distance=0,speedStyle="KT",hitbearing=0,useStratuxAHRS=!1,timestamp=new Date,isWarning=!1,warningVisible=!1,ip=document.getElementById("stxipaddr").value,wsp=parseInt(document.getElementById("wsport").value),urlTraffic="ws://"+ip+"/traffic",urlAHRS="http://"+ip+"/getSituation",urlCageAHRS="http://"+ip+"/cageAHRS",urlResetGMeter="http://"+ip+"/resetGMeter",urlSerialData="ws://localhost:"+wsp,KNOTS="KT",MPH="MPH",KPH="KPH",MILES="miles",KLIKS="km",NMILES="nm",distanceMeasure=MILES,windindicator=$(".windindicator"),tasindicator=$(".tasbox"),oatindicator=$(".oatbox"),baroindicator=$(".barobox"),daltindicator=$(".daltbox"),vsarrow=$(".vsarrowbox"),vsindicator=$(".vsbox"),courseindicator=$(".courseindicator"),coursecircle=$(".coursecircle"),coursearrow=$(".coursearrow");coursecircle.css("visibility","hidden"),coursearrow.css("visibility","hidden");var svgTraffic=document.getElementById("trafficwarning");svgTraffic.addEventListener("load",function(){var t=svgTraffic.contentDocument;warningIdentity=t.getElementById("ident"),warningAltitude=t.getElementById("alt"),warningDistance=t.getElementById("dist"),warningCourse=t.getElementById("crs")},!1);var usestx=document.getElementById("ahrs").value;useStratuxAHRS="Stratux"==usestx,speedStyle=document.getElementById("speedstyle").value;var speedFactor=1;switch(speedStyle){case MPH:speedFactor=1.15078,distanceMeasure=MILES;break;case KPH:speedFactor=1.852,distanceMeasure=KLIKS;break;default:distanceMeasure=NMILES}$(()=>{if(useStratuxAHRS)windindicator.css("left","-1000"),tasindicator.css("left","-1000"),runStratuxAhrs();else try{new WebSocket(urlSerialData).onmessage=onHostData}catch(t){console.log(t)}"true"==document.getElementById("trafficwarnings").value&&(warning_altitude=parseInt(document.getElementById("maxwarnaltitude").value),warning_distance=parseInt(document.getElementById("maxwarndistance").value),(trafficWebSocket=new WebSocket(urlTraffic)).onopen=function(t){onTrafficOpen(t)},trafficWebSocket.onclose=function(t){onTrafficClose(t)},trafficWebSocket.onmessage=function(t){onTrafficMessage(t)})}),function(t){function e(e,s){var a=t.extend({size:600,roll:0,pitch:0,showBox:!0},s),r={pitch_bound:90};function i(s){e.each(function(){t(this).find("div.instrument.attitude div.roll").css("transform","rotate("+s+"deg)")})}function n(s){s>r.pitch_bound?s=r.pitch_bound:s<-r.pitch_bound&&(s=-r.pitch_bound),e.each(function(){t(this).find("div.instrument.attitude div.roll div.pitch").css("top",.7*s+"%")})}return e.each(function(){t(this).html('<div class="instrument attitude"><div class="roll box"><img src="img/horizon_back.svg" class="box" alt="" /><div class="pitch box"><img src="img/horizon_ball.svg" class="box" alt="" /></div><img src="img/horizon_circle.svg" class="box" alt="" /></div><div class="mechanics box"><img src="img/horizon_airplane.svg" class="box" alt="" /></div></div>'),i(a.roll),n(a.pitch),t(this).find("div.instrument").css({height:500,width:600}),t(this).find("div.instrument img.box.background").toggle(a.showBox)}),this.setRoll=function(t){i(t)},this.setPitch=function(t){n(t)},this.resize=function(s){!function(s){e.each(function(){t(this).find("div.instrument").css({height:s,width:s})})}(s)},this.showBox=function(){e.each(function(){t(this).find("img.box.background").show()})},this.hideBox=function(){e.each(function(){t(this).find("img.box.background").hide()})},attitude}t.attitudeIndicator=function(s,a){return new e(t(s),a)},t.fn.attitudeIndicator=function(e){return this.each(function(){t.attitudeIndicator(this,e)})}}(jQuery);var speedtape=$("#speedtape"),alttape=$("#alttape"),headingtape=$("#headingtape"),ball=$("#ball"),attitude=$.attitudeIndicator("#attitude","attitude",{roll:50,pitch:-20,size:600,showBox:!0}),aoa=$(".aoa"),avgVspeed=new Array(10),isGarmin=!1,spd_offset=4.8,alt_offset=.4792,hdg_offset=4.793,ball_offset=6.7,ball_center=68,pitch_offset=useStratuxAHRS?1.19:1.24,speedbox=document.getElementById("spanspeedbox"),altitudebox=document.getElementById("spanaltbox"),headingbox=document.getElementById("spanheadingbox"),gbox=document.getElementById("spangmeter"),vspeedbox=document.getElementById("spanvspeed"),arrowbox=document.getElementById("spanvsarrow"),tasbox=document.getElementById("spantas"),oatbox=document.getElementById("spanoat"),daltbox=document.getElementById("spandalt"),windarrow=document.getElementById("windarrow"),windcircle=document.getElementById("windcircle"),windspeed=document.getElementById("spanwindspeed"),windlabel=document.getElementById("spanwindlabel"),barobox=document.getElementById("spanbaro"),aoatext=document.getElementById("spanaoa");function pad(t,e){for(var s=t+"";s.length<e;)s="0"+s;return s}var svgns="http://www.w3.org/2000/svg";function onHostData(t){var e=new HudData(t.data);isGarmin||"garmin"!=e.client||(isGarmin=!0,windindicator.css("left","-1000")),attitude.setRoll(-1*e.roll),attitude.setPitch(e.pitch*pitch_offset),speedbox.textContent=e.airspeed,headingbox.textContent=e.heading,arrowbox.textContent=e.vertspeed<0?"â–¼":"â–²",barobox.textContent="BARO "+e.baropressure.toFixed("2"),oatbox.textContent="OAT "+e.oatF+" F",tasbox.textContent="TAS "+e.tas+" kt",daltbox.textContent="DALT "+(e.dalt>=0?"+"+e.dalt:"-"+e.dalt),windspeed.textContent=isNaN(e.windkts)?"-- kt":e.windkts+" kt",altitudebox.textContent=e.baltitude,avgVspeed.length<3?avgVspeed.push(Math.abs(e.vertspeed)):(vspeedbox.textContent=GetAverage(avgVspeed)+" fpm",avgVspeed.splice(0,avgVspeed.length));var s=e.airspeed*spd_offset,a=e.baltitude*alt_offset,r=e.heading*hdg_offset*-1;myAlt=e.baltitude,e.aoa>=99?(aoa.css("visibility","visible"),aoatext.textContent="AOA-PUSH!"):aoa.css("visibility","hidden"),speedtape.css("transform","translateY("+s+"px)"),alttape.css("transform","translateY("+a+"px)"),headingtape.css("transform","translateX("+r+"px)"),gbox.textContent=(e.gLoad>=0?"+"+e.gLoad:"-"+e.gLoad)+" g";var i=ball_center+e.slipskid*ball_offset;ball.css("left",i+"px"),e.winddirection<180?e.winddirection+=180:e.winddirection-=180,windarrow.style.transform="rotate("+e.winddirection+"deg)"}function GetAverage(t){var e=0,s=0;return t.forEach(function(t){isNaN(t)||(e+=t,s++)}),(e/s).toFixed(0)}class HudData{constructor(t){if(this.str=String(t),this.id=this.str.substr(0,1),this.client="!"==this.id?"dynon":"garmin",this.pitch=parseInt(this.str.substr(11,4))/10,this.roll=parseInt(this.str.substr(15,5))/10,this.heading=parseInt(this.str.substr(20,3)),this.airspeed=Math.trunc(parseInt(this.str.substr(23,4))/10),this.altitude=parseInt(this.str.substr(27,6)),this.turnrate=parseInt(this.str.substr(33,4))/10,this.slipskid=parseInt(this.str.substr(37,3))/10,this.gLoad=(parseInt(this.str.substr(40,3))/10).toFixed(1),this.aoa=parseInt(this.str.substr(43,2)),this.vertspeed=Math.trunc(10*parseInt(this.str.substr(45,4))),this.oatF=Math.ceil(1.8*parseInt(this.str.substr(49,3))+32),this.oatC=parseInt(this.str.substr(49,3)),"dynon"==this.client)this.tas=Math.trunc(parseInt(this.str.substr(52,4))/10),this.baro=parseInt(this.str.substr(56,3)),this.dalt=parseInt(this.str.substr(59,6)),this.winddirection=parseInt(this.str.substr(65,3)),this.windkts=parseInt(this.str.substr(68,2));else if("garmin"==this.client){this.tas=tascalculator.tas(this.airspeed,this.altitude,this.oatC),this.baro=parseInt(this.str.substr(52,3));var e=2*this.altitude/1e3,s=Math.trunc(120*(this.oatC-(15-e)));this.dalt=this.altitude+s,this.winddirection=0,this.windkts=0}this.baropressure=this.baro/100+27.5;var a=0;switch(!0){case this.baropressure<=28:a=1824;break;case this.baropressure<=28.1:a=1727;break;case this.baropressure<=28.2:a=1630;break;case this.baropressure<=28.3:a=1533;break;case this.baropressure<=28.4:a=1436;break;case this.baropressure<=28.5:a=1340;break;case this.baropressure<=28.6:a=1244;break;case this.baropressure<=28.7:a=1148;break;case this.baropressure<=28.8:a=1053;break;case this.baropressure<=28.9:a=957;break;case this.baropressure<=29:a=863;break;case this.baropressure<=29.1:a=768;break;case this.baropressure<=29.2:a=673;break;case this.baropressure<=29.3:a=579;break;case this.baropressure<=29.4:a=485;break;case this.baropressure<=29.5:a=392;break;case this.baropressure<=29.6:a=298;break;case this.baropressure<=29.7:a=205;break;case this.baropressure<=29.8:a=112;break;case this.baropressure<=29.9:a=20;break;case this.baropressure<=29.92:a=0;break;case this.baropressure<=30:a=-73;break;case this.baropressure<=30.1:a=-165;break;case this.baropressure<=30.2:a=-257;break;case this.baropressure<=30.3:a=-348;break;case this.baropressure<=30.4:a=-440;break;case this.baropressure<=30.5:a=-531;break;case this.baropressure<=30.6:a=-622;break;case this.baropressure<=30.7:a=-712;break;case this.baropressure<=30.8:a=-803;break;case this.baropressure<=30.9:a=-893;break;case this.baropressure<=31:a=-983;break;default:a=0}var r=a*(29.92-this.baropressure);this.baltitude=round10(this.altitude+r)}}function round10(t){return 10*Math.round(t/10)}var tascalculator={tas:function(t,e){var s=.02*t,a=Math.floor(e/1e3);return Math.round(s*a+t)}};function perRound(t,e){var s;s=Number(e).toFixed(0);var a=t*Math.pow(10,s);return zerosPad(Math.round(a)/Math.pow(10,s),s)}function zerosPad(t,e){var s=t.toString(),a=s.indexOf("."),r=0;-1==a?s+=e>0?".":"":r=s.length-a-1;var i=e-r;if(i>0)for(var n=1;n<=i;n++)s+="0";return s}function clear_field(t){t.value==t.defaultValue&&(t.value="")}function runHeartbeatRoutine(){sendKeepAlive((new Date).getTime()),console.log("((ðŸ’œ))")}function sendKeepAlive(t){1==trafficWebSocket.readyState&&trafficWebSocket.send(t)}function onError(t){console.log("Traffic websocket ERROR: "+t.data)}function onTrafficOpen(t){console.log("Traffic warning websocket successfully connected to Stratux!"),wsOpen=!0,setInterval(runHeartbeatRoutine,15e3)}function onTrafficClose(t){console.log("Traffic warning Websocket CLOSED."),wsOpen=!1}function onTrafficMessage(t){var e,s=JSON.parse(t.data),a=Math.round(Number(s.Distance)),r=0,i=Math.round(Number(s.Bearing)),n=""!=s.Reg?s.Reg:s.Tail,o=Number(s.Alt),c=Number(s.Speed),d=new Date(s.Timestamp),u=Math.round(c*speedFactor),l=!s.OnGround;myAlt=Number(altitudebox.textContent);var h=i+"Â° @ "+(u=Math.round(c*speedFactor))+" "+speedStyle;switch(speedStyle){case KNOTS:r=Math.round(539957e-9*a),e=" nm";break;case MPH:r=Math.round(621371e-9*a),e=" mi";break;default:r=Math.round(.001*a),e=" km"}if(isWarning=!1,l&&o>0&&r>0){var b={reg:n,dist:r,alt:o,brng:i,course:h};if(r>warning_distance)hitmap.delete(n);else if(r<=warning_distance&&0!=o&&0!=u&&o<=myAlt+warning_altitude&&o>=myAlt-warning_altitude&&i>0&&u>0&&d>timestamp){hitmap.set(n,b),timestamp=d;var p=Array.from(hitmap.values()).sort(function(t,e){return t.dist>e.dist?1:-1});console.log(JSON.stringify(p));var f=p[0].reg;warningIdentity.textContent=f,warningAltitude.textContent=hitmap.get(f).alt,warningDistance.textContent=hitmap.get(f).dist+e,warningCourse.textContent=hitmap.get(f).course,hitbearing=hitmap.get(f).brng,p.forEach(function(t){t.reg!=f&&hitmap.delete(t.reg)})}hitmap.size>0?toggleTrafficWarning(!0,hitbearing):toggleTrafficWarning(!1)}else hitmap.delete(n)}function sortByDistance(...t){return t.sort(function(t,e){return t.dist>e.dist?1:-1})}function getSeconds(t,e){var s=e-t;return Math.abs(Math.round(.001*s))}function toggleTrafficWarning(t,e=0){t?(svgTraffic.setAttribute("style","visibility: visible"),coursearrow.css("visibility","visible"),coursecircle.css("visibility","visible"),courseindicator.css("visibility","visible"),coursearrow.css("transform","rotate("+e+"deg)"),warningVisible=!0):(svgTraffic.setAttribute("style","visibility: hidden"),coursearrow.css("visibility","hidden"),coursecircle.css("visibility","hidden"),courseindicator.css("visibility","hidden"),warningVisible=!1)}function runStratuxAhrs(){var t=0,e=0,s="",a=0;oatindicator.css("left","-1000"),baroindicator.css("left","-1000"),daltindicator.css("left","-1000"),vsarrow.css("top","422px"),vsindicator.css("top","422px"),fetch(urlCageAHRS),fetch(urlResetGMeter),setInterval(function(){fetch(urlAHRS).then(function(t){return t.json()}).then(function(r){var i=JSON.stringify(r),n=JSON.parse(i);attitude.setRoll(-1*n.AHRSRoll),attitude.setPitch(n.AHRSPitch*pitch_offset);var o=n.AHRSGLoad.toFixed(1),c=Math.trunc(n.AHRSSlipSkid),d=Math.trunc(1.8*n.BaroTemperature+32,0)+"Â° F";t=Number(n.GPSGroundSpeed*speedFactor).toFixed(0),e=Math.trunc(n.GPSAltitudeMSL),s=pad(Math.trunc(n.GPSTrueCourse),3),a=Math.trunc(n.GPSVerticalSpeed),speedbox.textContent=t,altitudebox.textContent=e,headingbox.textContent=s,vspeedbox.textContent=Math.abs(a)+" FPM",arrowbox.textContent=a<0?"â–¼":"â–²",oatbox.textContent=d;var u=t*spd_offset,l=e*alt_offset,h=s*hdg_offset*-1;speedtape.css("transform","translateY("+u+"px)"),alttape.css("transform","translateY("+l+"px"),headingtape.css("transform","translateX("+h+"px"),gbox.textContent=o+" G",c<-17?c=-17:c>17&&(c=17);var b=ball_center+c*ball_offset;ball.css("left",b+"px")})},50)}